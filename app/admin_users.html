<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estoque | Admin • Usuários</title>

  <!-- Favicons (opcional) -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#1a0e0e">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tema -->
  <link rel="stylesheet" href="theme.css"/>

  <style>
    /* Badges de papel */
    .role-badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);opacity:.9}
    .role-admin{background:#ff5b6c1a;color:#ffc9cf;border-color:#ff869144}
    .role-user{background:#5b4bff1a;color:#c9c6ff;border-color:#7b71ff44}

    /* Caixas de estado / dicas */
    .state{opacity:.9;padding:14px;border:1px dashed var(--border);border-radius:10px}
    .state.center{text-align:center}
    .hint-ok{color:#9BE39B}
    .hint-warn{color:#FFD18B}
    .hint-err{color:#FFD2D2}

    /* Tabela */
    .table-wrap{ background: var(--panel); border:1px solid var(--border); border-radius:12px; }
    .table thead th{
      background: var(--panel-2);
      color: var(--txt);
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>
<body class="app-body">

  <!-- NAVBAR (topo) -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <!-- Botão menu (mobile) -->
      <button class="btn-menu d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">
        <span class="hamburger"></span>
      </button>

      <a class="navbar-brand ms-2" href="#">Estoque -MD-</a>

      <div class="ms-auto">
        <button class="btn btn-logout-top" id="btnLogoutTop">Sair</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar d-none d-lg-block" id="sidebar">
    <div class="p-3" data-sidebar-content></div>
  </aside>

  <!-- Botão colapso (desktop) -->
  <button class="btn-menu toggle-desktop d-none d-lg-inline-flex" id="toggleDesktop" title="Colapsar/Expandir menu">
    <span class="hamburger"></span>
  </button>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasMenuBody"><!-- sidebar.js injeta aqui --></div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container-fluid">

      <header class="mb-3">
        <h2 class="page-title mb-1">Admin • Usuários</h2>
        <p class="text-muted">
          Vincule contas do <b>Firebase Auth</b> a papéis de acesso. Este painel grava em <code>users/{uid}</code> no Firestore com <code>{ email, role }</code>.
          <br><small class="text-muted">Para descobrir o <b>UID</b> de alguém: Console Firebase → Authentication → Usuários.</small>
        </p>
      </header>

      <!-- FORM -->
      <section class="card p-3 mb-3">
        <h5 class="mb-3">Novo / Editar</h5>
        <form id="formUser" novalidate>
          <div class="row g-3">
            <div class="col-12 col-lg-4">
              <label for="uUid" class="form-label">UID do usuário *</label>
              <input id="uUid" class="form-control" placeholder="Ex.: rJ9Q...Hk2" required>
            </div>
            <div class="col-12 col-lg-4">
              <label for="uEmail" class="form-label">E-mail *</label>
              <input id="uEmail" type="email" class="form-control" placeholder="usuario@igreja.org" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label">Papel (role) *</label>
              <div class="d-flex gap-3 align-items-center mt-1">
                <label class="form-check-label">
                  <input type="radio" class="form-check-input me-1" name="uRole" value="user"> Usuário
                </label>
                <label class="form-check-label">
                  <input type="radio" class="form-check-input me-1" name="uRole" value="admin"> Admin
                </label>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 align-items-center mt-3">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" id="btnClear" class="btn btn-ghost">Limpar</button>
            <span id="msg" class="ms-2"></span>
          </div>
        </form>
      </section>

      <!-- LISTA -->
      <section class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Usuários cadastrados</h5>
          <button class="btn btn-ghost" id="btnExportCsv">Exportar CSV</button>
        </div>

        <div id="stateBox" class="state center">Carregando usuários…</div>

        <div class="table-wrap mt-2">
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="tblUsers" style="display:none">
              <thead>
                <tr>
                  <th>E-mail</th>
                  <th>Papel</th>
                  <th>UID</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody><!-- linhas via JS --></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DIAGNÓSTICO -->
      <section class="card p-3 mb-5">
        <h5 class="mb-2">Diagnóstico de Permissões</h5>
        <div id="diag" class="text-muted">Carregando…</div>
      </section>

    </div>
  </main>

  <!-- Firebase + Sidebar -->
  <script src="firebase.js"></script>
  <script src="sidebar.js"></script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lógica -->
  <script>
    // Botão “Sair” do topo
    document.getElementById('btnLogoutTop')?.addEventListener('click', () => {
      if (window.auth && auth.signOut){ auth.signOut().then(()=> location.href='login.html'); }
      else { location.href='login.html'; }
    });

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const uUid   = $('#uUid');
    const uEmail = $('#uEmail');
    const msg    = $('#msg');

    function getRoleForm(){
      const r = document.querySelector('input[name="uRole"]:checked');
      return r ? r.value : '';
    }
    function setRoleForm(val){
      const r = document.querySelector('input[name="uRole"][value="'+val+'"]');
      if (r) r.checked = true;
    }

    const tbody    = $('#tblUsers tbody');
    const tableEl  = $('#tblUsers');
    const stateBox = $('#stateBox');

    let USERS = [];

    function roleBadge(role){
      if (role === 'admin') return '<span class="role-badge role-admin">admin</span>';
      return '<span class="role-badge role-user">user</span>';
    }

    function renderUsers(){
      if (!USERS.length){
        tableEl.style.display = 'none';
        stateBox.style.display = 'block';
        stateBox.textContent = 'Nenhum usuário cadastrado.';
        return;
      }
      stateBox.style.display = 'none';
      tableEl.style.display = '';

      tbody.innerHTML = USERS.map(u => `
        <tr data-id="${u.id}">
          <td>${u.email || '—'}</td>
          <td>${roleBadge(u.role || 'user')}</td>
          <td>${u.id}</td>
          <td class="text-end">
            <button class="btn btn-ghost btn-edit" data-id="${u.id}">Editar</button>
            <button class="btn btn-ghost btn-del" data-id="${u.id}">Excluir</button>
          </td>
        </tr>
      `).join('');

      $$('.btn-edit').forEach(b => b.onclick = () => fillForm(b.dataset.id));
      $$('.btn-del').forEach(b => b.onclick  = () => removeUser(b.dataset.id));
    }

    function fillForm(uid){
      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      uUid.value   = u.id;
      uEmail.value = u.email || '';
      setRoleForm(u.role || 'user');
      msg.textContent = '';
      msg.className = '';
      uUid.focus();
    }

    function clearForm(){
      uUid.value = '';
      uEmail.value = '';
      setRoleForm('user');
      msg.textContent = '';
      msg.className = '';
      uUid.focus();
    }
    $('#btnClear').onclick = clearForm;

    async function saveUser(e){
      e.preventDefault();
      msg.textContent = '';
      msg.className = '';

      const uid = uUid.value.trim();
      const email = uEmail.value.trim();
      const role = getRoleForm();

      if (!uid || !email || !role){
        msg.textContent = 'Preencha UID, e-mail e papel.';
        msg.classList.add('hint-warn');
        return;
      }

      try{
        await db.collection('users').doc(uid).set({ email, role }, { merge:true });
        msg.textContent = 'Salvo com sucesso.';
        msg.classList.add('hint-ok');
        clearForm();
      }catch(err){
        console.error(err);
        msg.textContent = err.message || 'Falha ao salvar.';
        msg.classList.add('hint-err');
      }
    }
    $('#formUser').addEventListener('submit', saveUser);

    async function removeUser(uid){
      if (!confirm('Remover o vínculo do usuário? (Não apaga a conta do Auth)')) return;

      // (Opcional) impede apagar a si mesmo
      try{
        const me = auth.currentUser?.uid;
        if (me && me === uid){
          alert('Você não pode remover a si mesmo.');
          return;
        }
      }catch(_){}

      try{
        await db.collection('users').doc(uid).delete();
      }catch(err){
        alert('Erro ao excluir: ' + (err.message || err));
      }
    }

    function watchUsers(){
      db.collection('users').orderBy('email').onSnapshot(snap=>{
        USERS = [];
        snap.forEach(doc => USERS.push({ id:doc.id, ...doc.data() }));
        renderUsers();
      }, err=>{
        console.error(err);
        stateBox.style.display = 'block';
        tableEl.style.display  = 'none';
        stateBox.textContent   = 'Erro ao carregar: ' + (err.message || err);
      });
    }

    // Exportar CSV
    $('#btnExportCsv').onclick = () => {
      if (!USERS.length) return;
      const rows = [['email','role','uid'], ...USERS.map(u => [u.email||'', u.role||'', u.id])];
      const csv  = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `usuarios_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    };

    // Diagnóstico
    function loadDiag(){
      const out = $('#diag');
      const u = auth.currentUser;
      if (!u){ out.textContent = 'Não autenticado.'; return; }

      db.collection('users').doc(u.uid).get().then(snap=>{
        const role = snap.exists ? (snap.data().role || 'user') : '—';
        const okAdmin = role === 'admin';
        out.innerHTML = `
          <div><b>UID:</b> ${u.uid}</div>
          <div><b>E-mail:</b> ${u.email || '—'}</div>
          <div><b>Role:</b> <span class="${okAdmin?'hint-ok':'hint-warn'}">${role}</span></div>
          <div class="text-muted" style="margin-top:6px">
            As regras do Firestore exigem <code>request.auth != null</code> para ler/escrever e,
            para coleções críticas, <code>role=admin</code> em <code>users/{uid}</code>.
          </div>
        `;
      }).catch(err=>{
        out.innerHTML = `<span class="hint-err">Erro ao ler seu papel: ${err.message || err}</span>`;
      });
    }

    // Start
    window.addEventListener('firebase-ready', () => {
      auth.onAuthStateChanged(u=>{
        if(!u){ location.href = 'login.html'; return; }
        watchUsers();
        loadDiag();
      });
    });
  </script>
</body>
</html>
