<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatórios | MD Estoque</title>

  <!-- Favicons -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#1a0e0e">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tema -->
  <link rel="stylesheet" href="theme.css"/>

  <style>
    .state{opacity:.9;padding:14px;border:1px dashed var(--border);border-radius:10px}
    .state.center{text-align:center}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px;margin-top:8px}
    .kpi .card{padding:12px 14px}
    .kpi h4{margin:0 0 4px}
    .kpi p{margin:0;opacity:.85}
    @media (max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.kpi{grid-template-columns:1fr}}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;font-weight:600}
    .badge.in  {background:#5b4bff1a;color:#b9b4ff;border:1px solid #6f63ff44}
    .badge.out {background:#ff5b6c1a;color:#ffb7bf;border:1px solid #ff7e8b44}

    /* -------- Cabeçalho que só aparece no PDF -------- */
    .print-header{display:none; margin-bottom:18px}
    .print-header__row{display:flex; align-items:center; gap:12px}
    .print-header__logo{width:44px;height:44px;object-fit:contain}
    .print-header__title{margin:0;font-size:1.25rem;font-weight:700}
    .print-header__meta{margin:2px 0 0; opacity:.8}

    /* -------- Estilos de impressão -------- */
    @media print{
      :root{ color-scheme: light; }
      body{ background:#fff; }
      .sidebar,
      .navbar,
      .toggle-desktop,
      .page-header .page-subtitle,
      .card .actions,
      .card .form-actions,
      .card .card__header { display:none !important; }

      .content{ padding-top:8px; }
      .card{ box-shadow:none; }

      .print-header{ display:block; }

      /* tabelas mais legíveis no papel */
      table{ width:100% !important; border-collapse:collapse !important; font-size:12px !important; }
      table thead th{ border:1px solid #ccc !important; background:#f4f4f4 !important; color:#000 !important; padding:6px !important; }
      table tbody td{ border:1px solid #ddd !important; color:#000 !important; padding:6px !important; }

      /* KPIs em linha no topo do PDF */
      .kpi{ display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin:10px 0 16px; }
      .kpi .card{ border:1px solid #e5e5e5; padding:10px 12px; box-shadow:none; }
      .kpi h4{ font-size:12px; margin:0 0 4px; color:#000; }
      .kpi p{ font-size:14px; margin:0; color:#000; }

      /* quebra de página antes da tabela de detalhes (se necessário) */
      #tblDetalhe{ page-break-inside:auto; }
      #tblDetalhe tr{ page-break-inside:avoid; page-break-after:auto; }
    }
  </style>
</head>
<body class="app-body">

  <!-- NAVBAR (topo) -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <!-- Botão menu (mobile) -->
      <button class="btn-menu d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">
        <span class="hamburger"></span>
      </button>

      <a class="navbar-brand ms-2" href="#">Estoque -MD-</a>

      <div class="ms-auto">
        <button class="btn btn-logout-top" id="btnLogoutTop">Sair</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar d-none d-lg-block" id="sidebar">
    <div class="p-3" data-sidebar-content></div>
  </aside>

  <!-- Botão colapso (desktop) -->
  <button class="btn-menu toggle-desktop d-none d-lg-inline-flex" id="toggleDesktop" title="Colapsar/Expandir menu">
    <span class="hamburger"></span>
  </button>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasMenuBody"><!-- sidebar.js injeta aqui --></div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content" id="page-rel">
    <div class="container-fluid">
      <header class="page-header">
        <h2 class="page-title">Relatórios</h2>
        <p class="page-subtitle">
          Gere relatórios por período. Use as datas para escolher no calendário, ou selecione um mês e aplique.
        </p>
      </header>

      <!-- Cabeçalho (só no PDF) -->
      <div class="print-header" id="printHeader">
        <div class="print-header__row">
          <img src="logo.png" alt="Logo" class="print-header__logo">
          <div>
            <h3 class="print-header__title">Relatório de Movimentações — MD | Estoque</h3>
            <p class="print-header__meta" id="printMeta">Período: --/--/---- a --/--/---- • Gerado em --/--/---- --:--</p>
          </div>
        </div>
      </div>

      <!-- FILTRO -->
      <section class="card p-3 mb-3">
        <div class="row g-3">
          <div class="col-12 col-lg-4">
            <label for="rMes" class="form-label">Atalho: Mês</label>
            <input type="month" id="rMes" class="form-control">
          </div>
          <div class="col-12 col-lg-4">
            <label for="rDe" class="form-label">Data (de)</label>
            <input type="date" id="rDe" class="form-control" required>
          </div>
          <div class="col-12 col-lg-4">
            <label for="rAte" class="form-label">Data (até)</label>
            <input type="date" id="rAte" class="form-control" required>
          </div>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary" id="btnGerar">Gerar relatório</button>
          <button class="btn btn-ghost" id="btnCsvResumo">Exportar CSV (Resumo)</button>
          <button class="btn btn-ghost" id="btnCsvDetalhe">Exportar CSV (Detalhes)</button>
          <button class="btn btn-ghost" id="btnPdf">Exportar PDF</button>
          <span id="relMsg" class="text-muted"></span>
        </div>
      </section>

      <!-- KPIs -->
      <section class="kpi" id="kpis" style="display:none">
        <div class="card"><h4>Total de Movimentos</h4><p id="kMov">0</p></div>
        <div class="card"><h4>Total Entradas</h4><p id="kIn">0</p></div>
        <div class="card"><h4>Total Saídas</h4><p id="kOut">0</p></div>
        <div class="card"><h4>Saldo (Entradas-Saídas)</h4><p id="kSaldo">0</p></div>
      </section>

      <!-- RESUMO -->
      <section class="card">
        <div class="card__header"><h3 class="card__subtitle">Resumo por Item</h3></div>
        <div id="stateResumo" class="state center">Escolha o período e clique em “Gerar relatório”.</div>
        <div class="table-wrap">
          <table id="tblResumo" class="table table-hover align-middle" style="display:none">
            <thead>
              <tr>
                <th>Item</th>
                <th>Entradas</th>
                <th>Saídas</th>
                <th>Saldo</th>
                <th>Movs.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- DETALHES -->
      <section class="card">
        <div class="card__header"><h3 class="card__subtitle">Movimentações do Período</h3></div>
        <div id="stateDetalhe" class="state center" style="display:none">Nenhuma movimentação no período.</div>
        <div class="table-wrap">
          <table id="tblDetalhe" class="table table-hover align-middle" style="display:none">
            <thead>
              <tr>
                <th>Data</th>
                <th>Item</th>
                <th>Tipo</th>
                <th>Qtd</th>
                <th>Usuário</th>
                <th>Obs.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- Firebase + Sidebar -->
  <script src="firebase.js"></script>
  <script src="sidebar.js"></script>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Botão “Sair” do topo
    document.getElementById('btnLogoutTop')?.addEventListener('click', () => {
      if (window.auth && auth.signOut){ auth.signOut().then(()=> location.href='login.html'); }
      else { location.href='login.html'; }
    });

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const rMes = $('#rMes');
    const rDe  = $('#rDe');
    const rAte = $('#rAte');

    const btnGerar = $('#btnGerar');
    const btnCsvResumo  = $('#btnCsvResumo');
    const btnCsvDetalhe = $('#btnCsvDetalhe');
    const btnPdf = $('#btnPdf');
    const msg = $('#relMsg');

    const kpis   = $('#kpis');
    const kMov   = $('#kMov');
    const kIn    = $('#kIn');
    const kOut   = $('#kOut');
    const kSaldo = $('#kSaldo');

    const stateResumo  = $('#stateResumo');
    const tblResumo    = $('#tblResumo');
    const resumoBody   = $('#tblResumo tbody');

    const stateDetalhe = $('#stateDetalhe');
    const tblDetalhe   = $('#tblDetalhe');
    const detalheBody  = $('#tblDetalhe tbody');

    // Helpers de data
    function startOfMonth(strYYYYMM){
      const [y,m] = strYYYYMM.split('-').map(Number);
      return new Date(y, m-1, 1, 0,0,0,0);
    }
    function endOfMonth(strYYYYMM){
      const [y,m] = strYYYYMM.split('-').map(Number);
      return new Date(y, m, 0, 23,59,59,999);
    }
    function startOfDay(strYMD){ return new Date(strYMD + 'T00:00:00'); }
    function endOfDay(strYMD){ return new Date(strYMD + 'T23:59:59.999'); }

    function fmtDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
      }catch(_){ return '--/--/---- --:--'; }
    }

    // Aplicar mês → preenche datas de/até
    rMes.addEventListener('change', ()=>{
      if(!rMes.value) return;
      const ini = startOfMonth(rMes.value);
      const fim = endOfMonth(rMes.value);
      rDe.value  = ini.toISOString().slice(0,10);
      rAte.value = fim.toISOString().slice(0,10);
    });

    function resetTables(){
      resumoBody.innerHTML = '';
      detalheBody.innerHTML = '';
      tblResumo.style.display = 'none';
      tblDetalhe.style.display = 'none';
      stateDetalhe.style.display = 'none';
      kpis.style.display = 'none';
    }

    async function gerar(){
      msg.textContent = '';
      resetTables();

      if(!rDe.value || !rAte.value){
        stateResumo.style.display = 'block';
        stateResumo.textContent   = 'Selecione “Data de” e “Data até”.';
        return;
      }

      const ini = startOfDay(rDe.value);
      const fim = endOfDay(rAte.value);

      stateResumo.style.display = 'block';
      stateResumo.textContent   = 'Gerando…';

      try{
        const snap = await db.collection('movimentacoes')
          .where('data','>=', ini)
          .where('data','<=', fim)
          .orderBy('data','asc')
          .get();

        const movimentos = [];
        snap.forEach(doc => movimentos.push({ id:doc.id, ...doc.data() }));

        if (movimentos.length === 0){
          stateResumo.textContent = 'Nenhuma movimentação no período.';
          stateDetalhe.style.display = 'block';
          stateDetalhe.textContent  = '—';
          updatePrintMeta();
          return;
        }

        // Resumo por item
        const mapa = new Map();
        let totalIn = 0, totalOut = 0;

        movimentos.forEach(m=>{
          const nome = m.itemNome || '(sem nome)';
          const r = mapa.get(nome) || { item:nome, in:0, out:0, movs:0 };
          if (m.tipo === 'entrada'){ r.in  += Number(m.qtd||0); totalIn  += Number(m.qtd||0); }
          else                     { r.out += Number(m.qtd||0); totalOut += Number(m.qtd||0); }
          r.movs += 1;
          mapa.set(nome, r);
        });

        resumoBody.innerHTML = Array.from(mapa.values())
          .sort((a,b)=> a.item.localeCompare(b.item))
          .map(r => `
            <tr>
              <td>${r.item}</td>
              <td>${r.in}</td>
              <td>${r.out}</td>
              <td>${r.in - r.out}</td>
              <td>${r.movs}</td>
            </tr>
          `).join('');

        stateResumo.style.display = 'none';
        tblResumo.style.display   = '';

        // KPIs
        kpis.style.display = '';
        kMov.textContent   = String(movimentos.length);
        kIn.textContent    = String(totalIn);
        kOut.textContent   = String(totalOut);
        kSaldo.textContent = String(totalIn - totalOut);

        // Detalhes
        detalheBody.innerHTML = movimentos.map(m=>`
          <tr>
            <td>${fmtDate(m.data)}</td>
            <td>${m.itemNome || '—'}</td>
            <td><span class="badge ${m.tipo==='entrada'?'in':'out'}">${m.tipo==='entrada'?'Entrada':'Saída'}</span></td>
            <td>${m.qtd}</td>
            <td>${m.usuarioNome || m.usuario || '—'}</td>
            <td>${m.obs ? String(m.obs).replace(/</g,'&lt;') : ''}</td>
          </tr>
        `).join('');
        tblDetalhe.style.display = '';
        stateDetalhe.style.display = 'none';

        msg.textContent = 'Relatório gerado com sucesso.';
        updatePrintMeta();
      }catch(err){
        console.error(err);
        stateResumo.style.display = 'block';
        stateResumo.textContent   = 'Erro ao gerar: ' + (err.message || err);
      }
    }

    // Atualiza o texto do cabeçalho que sai no PDF
    function updatePrintMeta(){
      const meta = document.getElementById('printMeta');
      const agora = new Date();
      const dd = String(agora.getDate()).padStart(2,'0');
      const mm = String(agora.getMonth()+1).padStart(2,'0');
      const yyyy = agora.getFullYear();
      const hh = String(agora.getHours()).padStart(2,'0');
      const mi = String(agora.getMinutes()).padStart(2,'0');
      const gerado = `${dd}/${mm}/${yyyy} ${hh}:${mi}`;

      const pDe  = rDe.value ? rDe.value.split('-').reverse().join('/') : '--/--/----';
      const pAte = rAte.value ? rAte.value.split('-').reverse().join('/') : '--/--/----';

      meta.textContent = `Período: ${pDe} a ${pAte} • Gerado em ${gerado}`;
    }

    // CSVs / PDF
    function exportTableToCsv(tableSel, filename){
      const table = $(tableSel);
      if (!table || table.style.display === 'none'){
        msg.textContent = 'Nada para exportar.';
        return;
      }
      const ths = $$(tableSel + ' thead th').map(th=>th.textContent.trim());
      const trs = Array.from(table.querySelector('tbody').querySelectorAll('tr')).map(tr =>
        Array.from(tr.children).map(td => '"' + (td.textContent||'').replaceAll('"','""') + '"').join(',')
      );
      if(!trs.length){ msg.textContent = 'Nada para exportar.'; return; }
      const csv = [ths.join(','), ...trs].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }
    function exportResumo(){ exportTableToCsv('#tblResumo',  `relatorio_resumo_${rDe.value}_${rAte.value}.csv`); }
    function exportDetalhe(){ exportTableToCsv('#tblDetalhe', `relatorio_detalhes_${rDe.value}_${rAte.value}.csv`); }
    function exportPDF(){ updatePrintMeta(); window.print(); }

    btnGerar.addEventListener('click', gerar);
    btnCsvResumo.addEventListener('click', exportResumo);
    btnCsvDetalhe.addEventListener('click', exportDetalhe);
    btnPdf.addEventListener('click', exportPDF);

    // inicialização
    window.addEventListener('firebase-ready', ()=>{
      auth.onAuthStateChanged(u=>{
        if(!u){ location.href='login.html'; return; }
        // sugere mês atual (datas de/até do mês)
        const now = new Date();
        const ym  = now.toISOString().slice(0,7);
        rMes.value = ym;
        const ini = new Date(now.getFullYear(), now.getMonth(), 1);
        const fim = new Date(now.getFullYear(), now.getMonth()+1, 0);
        rDe.value  = ini.toISOString().slice(0,10);
        rAte.value = fim.toISOString().slice(0,10);
      });
    });
  </script>
</body>
</html>
