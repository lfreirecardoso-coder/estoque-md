<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estoque | Novo Item</title>

  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#1a0e0e">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tema -->
  <link rel="stylesheet" href="theme.css"/>

  <style>
    /* complementos leves para esta página */
    .photo-area{
      width: 160px; height: 160px;
      border-radius: 14px; border:1px solid var(--border);
      background: var(--panel-2);
      display:flex; align-items:center; justify-content:center;
      position: relative; overflow:hidden;
    }
    .photo-area img{ max-width:100%; max-height:100%; object-fit:cover; }
    .photo-actions{ display:flex; gap:.5rem; margin-top:.5rem; }
    .small-muted{ font-size:.9rem; color:var(--muted); }
    .form-help{ font-size:.85rem; color:var(--muted); margin-top:.25rem; }
  </style>
</head>

<body class="app-body">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <button class="btn-menu d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">
        <span class="hamburger"></span>
      </button>
      <a class="navbar-brand ms-2" href="dashboard.html">Estoque -MD-</a>
      <div class="ms-auto">
        <button class="btn btn-logout-top" id="btnLogoutTop">Sair</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR DESKTOP -->
  <aside class="sidebar d-none d-lg-block" id="sidebar">
    <div class="p-3" data-sidebar-content></div>
  </aside>

  <!-- Botão colapso sidebar (desktop) -->
  <button class="btn-menu toggle-desktop d-none d-lg-inline-flex" id="toggleDesktop" title="Colapsar/Expandir menu">
    <span class="hamburger"></span>
  </button>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasMenuBody"><!-- sidebar.js injeta aqui --></div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container-fluid">

      <header class="mb-3">
        <h2 class="page-title mb-1" id="pageTitle">Novo Item</h2>
        <p class="text-muted">Cadastre um novo item ou edite um existente.</p>
      </header>

      <section class="card p-3">
        <div class="row g-4">
          <!-- Coluna esquerda: imagem -->
          <div class="col-12 col-md-4 col-lg-3">
            <div class="photo-area" id="photoArea">
              <img id="preview" src="img/placeholder.svg" alt="Pré-visualização">
            </div>
            <div class="photo-actions">
              <label class="btn btn-ghost mb-0">
                Selecionar foto
                <input type="file" id="foto" accept="image/*" hidden>
              </label>
              <button class="btn btn-ghost" id="btnLimparFoto" type="button">Limpar</button>
            </div>
            <div class="form-help">Se não escolher uma foto, o sistema usará essa imagem de placeholder.</div>
          </div>

          <!-- Coluna direita: campos -->
          <div class="col-12 col-md-8 col-lg-9">
            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <label class="form-label" for="nome">Nome *</label>
                <input class="form-control" id="nome" placeholder="Ex.: Fio 2.5 mm" required>
              </div>

              <div class="col-12 col-lg-6">
                <label class="form-label" for="categoria">Categoria</label>
                <input class="form-control" id="categoria" list="listaCategorias" placeholder="Ex.: Elétrica, Som...">
                <datalist id="listaCategorias"></datalist>
                <div class="form-help">Você pode manter livre ou selecionar entre as categorias cadastradas.</div>
              </div>

              <div class="col-6 col-lg-3">
                <label class="form-label" for="qtd">Quantidade</label>
                <input class="form-control" id="qtd" type="number" min="0" step="1" value="0">
              </div>

              <div class="col-6 col-lg-3">
                <label class="form-label" for="unidade">Unidade</label>
                <input class="form-control" id="unidade" placeholder="Ex.: UN, m, cm">
              </div>

              <div class="col-12 col-lg-6">
                <label class="form-label" for="local">Local de Armazenamento</label>
                <input class="form-control" id="local" placeholder="Ex.: Caixa 1, Depósito A">
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <button class="btn btn-primary" id="btnSalvar">Salvar</button>
              <button class="btn btn-ghost" id="btnVoltar" type="button">Voltar</button>
              <button class="btn btn-danger d-none" id="btnExcluir" type="button">Excluir</button>
              <span class="small-muted" id="msg"></span>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Firebase / Sidebar / Bootstrap -->
  <script src="firebase.js"></script>
  <script src="sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Sair pelo topo
    document.getElementById('btnLogoutTop')?.addEventListener('click', () => {
      if (window.auth?.signOut) auth.signOut().then(() => location.href='login.html');
      else location.href = 'login.html';
    });

    const $ = (s) => document.querySelector(s);
    const msg = $('#msg');
    const preview = $('#preview');
    const foto = $('#foto');
    const btnLimparFoto = $('#btnLimparFoto');
    const btnSalvar = $('#btnSalvar');
    const btnVoltar = $('#btnVoltar');
    const btnExcluir = $('#btnExcluir');
    const pageTitle = $('#pageTitle');

    const nome = $('#nome');
    const categoria = $('#categoria');
    const qtd = $('#qtd');
    const unidade = $('#unidade');
    const localArmaz = $('#local');

    const params = new URLSearchParams(location.search);
    const itemId = params.get('id');
    const isEdit = !!itemId;

    // Preview ao escolher arquivo
    foto.addEventListener('change', () => {
      const f = foto.files?.[0];
      if (f) preview.src = URL.createObjectURL(f);
    });
    btnLimparFoto.addEventListener('click', () => {
      foto.value = '';
      preview.src = 'img/placeholder.svg';
    });

    btnVoltar.addEventListener('click', () => history.back());

    // Carrega categorias p/ datalist
    async function carregarCategorias(){
      try{
        const snap = await db.collection('categorias').orderBy('nome').get();
        const dl = document.getElementById('listaCategorias');
        dl.innerHTML = '';
        snap.forEach(doc=>{
          const opt = document.createElement('option');
          opt.value = doc.data().nome || '';
          dl.appendChild(opt);
        });
      }catch(e){ console.warn('Categorias:', e.message || e); }
    }

    // Carrega dados do item se for edição
    async function carregarItem(){
      if (!isEdit) return;
      try{
        const doc = await db.collection('itens').doc(itemId).get();
        if (!doc.exists){ alert('Item não encontrado.'); location.href='dashboard.html'; return; }
        const d = doc.data();
        pageTitle.textContent = 'Editar Item';
        btnExcluir.classList.remove('d-none');

        nome.value = d.nome || '';
        categoria.value = d.categoria || '';
        qtd.value = Number(d.qtd || 0);
        unidade.value = d.unidade || '';
        localArmaz.value = d.local || '';
        preview.src = d.imageUrl || 'img/placeholder.svg';
      }catch(e){
        console.error(e);
        alert('Erro ao carregar: ' + (e.message || e));
      }
    }

    // Salvar (criar/editar) — com upload do placeholder se não houver foto
    async function salvarItem(){
      try{
        msg.textContent = 'Salvando...';
        const nomeVal = nome.value.trim();
        if (!nomeVal){ alert('Informe o nome.'); return; }

        const payloadBase = {
          nome: nomeVal,
          categoria: categoria.value.trim(),
          qtd: Number(qtd.value || 0),
          unidade: unidade.value.trim(),
          local: localArmaz.value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const itensCol = db.collection('itens');
        let docRef, currentData = {};

        if (isEdit){
          docRef = itensCol.doc(itemId);
          const snap = await docRef.get();
          currentData = snap.exists ? (snap.data() || {}) : {};
          if (!snap.exists){ alert('Item não encontrado.'); return; }
        } else {
          docRef = itensCol.doc(); // precisamos do ID antes para nomear a imagem
          payloadBase.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        // Upload de imagem (arquivo escolhido, ou placeholder.svg se não tiver imagem)
        let imageUrl = '';
        const file = foto.files?.[0] || null;
        const storage = firebase.storage();

        if (file){
          const ext = (file.name.split('.').pop() || 'png').toLowerCase();
          const ref = storage.ref(`itens/${docRef.id}.${ext}`);
          const meta = { contentType: file.type || 'application/octet-stream' };
          await ref.put(file, meta);
          imageUrl = await ref.getDownloadURL();
        } else {
          if (isEdit && currentData.imageUrl){
            // mantém imagem existente na edição quando o usuário não troca a foto
            imageUrl = currentData.imageUrl;
          } else {
            // sobe o placeholder.svg
            const resp = await fetch('img/placeholder.svg');
            if (!resp.ok) throw new Error('Não encontrei img/placeholder.svg');
            const blob = await resp.blob();
            const ref = storage.ref(`itens/${docRef.id}.svg`);
            const meta = { contentType: 'image/svg+xml' };
            await ref.put(blob, meta);
            imageUrl = await ref.getDownloadURL();
          }
        }

        const payload = { ...payloadBase, imageUrl };
        await docRef.set(payload, { merge:true });

        msg.textContent = 'Salvo com sucesso!';
        setTimeout(()=> location.href='dashboard.html', 600);
      }catch(e){
        console.error(e);
        msg.textContent = 'Erro ao salvar.';
        alert('Erro ao salvar: ' + (e.message || e));
      }
    }

    // Excluir item (apenas em edição)
    async function excluirItem(){
      if (!confirm('Tem certeza que deseja excluir este item?')) return;
      try{
        await db.collection('itens').doc(itemId).delete();
        alert('Item excluído.');
        location.href = 'dashboard.html';
      }catch(e){
        console.error(e);
        alert('Erro ao excluir: ' + (e.message || e));
      }
    }

    btnSalvar.addEventListener('click', (e)=>{ e.preventDefault(); salvarItem(); });
    btnExcluir.addEventListener('click', (e)=>{ e.preventDefault(); excluirItem(); });

    // Protege a página e inicia
    window.addEventListener('firebase-ready', () => {
      auth.onAuthStateChanged(u=>{
        if (!u){ location.href='login.html'; return; }
        carregarCategorias();
        carregarItem();
      });
    });
  </script>
</body>
</html>
