<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estoque | Cadastro de Estoque</title>

  <!-- Favicons -->
  <link rel="icon" href="favicon.ico?v=20250826" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png?v=20250826" sizes="32x32">
  <link rel="apple-touch-icon" href="apple-touch-icon.png?v=20250826" sizes="180x180">
  <meta name="theme-color" content="#1a0e0e">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tema -->
  <link rel="stylesheet" href="theme.css?v=20250826"/>
  <style>
    .upload-status{ font-size:.95rem }
    .upload-status.ok{ color:#9BE39B }
    .upload-status.err{ color:#FFD2D2 }
    .progress{ height:8px }
  </style>
</head>
<body class="app-body">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <!-- Bot√£o menu (mobile) -->
      <button class="btn-menu d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">
        <span class="hamburger"></span>
      </button>

      <a class="navbar-brand ms-2" href="#">Estoque -MD-</a>

      <div class="ms-auto">
        <button class="btn btn-logout-top" id="btnLogoutTop">Sair</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar d-none d-lg-block" id="sidebar">
    <div class="p-3" data-sidebar-content></div>
  </aside>

  <!-- Bot√£o colapso (desktop) -->
  <button class="btn-menu toggle-desktop d-none d-lg-inline-flex" id="toggleDesktop" title="Colapsar/Expandir menu">
    <span class="hamburger"></span>
  </button>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasMenuBody"><!-- sidebar.js injeta aqui --></div>
  </div>

  <!-- CONTE√öDO -->
  <main class="content">
    <div class="container-fluid">

      <header class="mb-3">
        <h2 class="page-title mb-1">Cadastro de Estoque</h2>
        <p class="text-muted">
          Preencha os campos. Voc√™ pode tirar uma foto pelo celular ou escolher uma imagem.
          <a class="btn btn-ghost btn-sm ms-1" href="cadastro_base.html">Cadastro Base</a>
        </p>
      </header>

      <section class="card p-3">
        <form id="formItem" novalidate>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label for="iNome" class="form-label">Nome *</label>
              <input id="iNome" type="text" class="form-control" placeholder="Ex.: Fio 2.5 mm" required>
            </div>

            <div class="col-12 col-lg-6">
              <label for="iCategoria" class="form-label">Categoria *</label>
              <select id="iCategoria" class="form-select" required>
                <option value="">‚Äî Selecione ‚Äî</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="iQtd" class="form-label">Quantidade *</label>
              <input id="iQtd" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="Ex.: 10" required>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="iUnidade" class="form-label">Unidade *</label>
              <select id="iUnidade" class="form-select" required>
                <option value="">‚Äî Selecione ‚Äî</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <label for="iLocal" class="form-label">Local de Armazenamento *</label>
              <select id="iLocal" class="form-select" required>
                <option value="">‚Äî Selecione ‚Äî</option>
              </select>
            </div>

            <!-- IMAGEM -->
            <div class="col-12">
              <label class="form-label">Imagem do Item (opcional)</label>
              <div class="d-flex gap-3 align-items-start flex-wrap">
                <img id="iPreview" class="thumb" alt="Pr√©-visualiza√ß√£o" style="width:96px;height:96px;border-radius:12px;border:1px solid var(--border);object-fit:cover"/>
                <div style="min-width:260px">
                  <input id="iFoto" class="d-none" type="file" accept="image/*">
                  <div class="d-flex flex-wrap gap-2">
                    <label for="iFoto" class="btn btn-ghost">üìÇ Escolher arquivo</label>
                    <button type="button" class="btn btn-ghost" id="btnAbrirCamera">üì∏ Tirar foto</button>
                    <button type="button" class="btn btn-danger" id="btnRemoverImg">üóë Remover imagem</button>
                  </div>

                  <div class="text-muted small mt-2">
                    No celular, ‚ÄúEscolher arquivo‚Äù abre c√¢mera ou galeria; ‚ÄúTirar foto‚Äù tenta abrir a c√¢mera direta (quando suportado).
                  </div>

                  <!-- Status de upload -->
                  <div class="mt-2">
                    <div class="progress d-none" id="upBar"><div class="progress-bar" id="upBarFill" style="width:0%"></div></div>
                    <div class="upload-status" id="iUploadInfo"></div>
                  </div>
                </div>
              </div>
            </div>

            <input id="iImageUrl" type="hidden">
          </div>

          <div class="d-flex align-items-center gap-2 mt-3">
            <button type="submit" class="btn btn-primary" id="btnSalvar">üíæ Salvar</button>
            <a href="dashboard.html" class="btn btn-ghost">Cancelar</a>
            <span class="text-muted ms-2" id="iMsg"></span>
          </div>
        </form>
      </section>

    </div>
  </main>

  <!-- MODAL da C√ÇMERA -->
  <div class="modal" id="camModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">C√¢mera</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar" id="btnFecharCam"></button>
        </div>
        <div class="modal-body">
          <div class="ratio ratio-4x3" style="background:#000;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
            <video id="camVideo" autoplay playsinline></video>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button class="btn btn-ghost" id="btnTrocar">Trocar c√¢mera</button>
          <button class="btn btn-primary" id="btnCapturar">Capturar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="firebase.js?v=20250826"></script>
  <!-- Sidebar unificada -->
  <script src="sidebar.js?v=20250826"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- L√ìGICA -->
  <script>
    // Bot√£o ‚ÄúSair‚Äù do topo
    document.getElementById('btnLogoutTop')?.addEventListener('click', () => {
      if (window.auth && auth.signOut){ auth.signOut().then(()=> location.href='login.html'); }
      else { location.href='login.html'; }
    });

    /* ========= Placeholder (imagem gen√©rica) ========= */
    const PLACEHOLDER =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="320" height="320" viewBox="0 0 320 320">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#1d1414"/>
            <stop offset="1" stop-color="#2a1717"/>
          </linearGradient>
        </defs>
        <rect width="320" height="320" rx="18" fill="url(#g)"/>
        <g fill="none" stroke="#9e8bd1" stroke-width="10" opacity="0.65">
          <rect x="60" y="90" width="200" height="140" rx="12"/>
          <circle cx="120" cy="140" r="22"/>
          <path d="M90 210l48-48 35 35 25-25 32 38"/>
        </g>
      </svg>`);

    function setPlaceholder(){
      document.getElementById('iPreview').src = PLACEHOLDER;
      setUploadInfo('Sem imagem (usando gen√©rica).', 'muted');
    }

    /* ========= Combos (categorias/locais/unidades) ========= */
    const CFG_COL = 'config';

    function fillSelect(sel, arr, selected){
      sel.innerHTML = '<option value="">‚Äî Selecione ‚Äî</option>';
      arr.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
        const o=document.createElement('option');o.value=v;o.textContent=v;
        if(selected && selected===v) o.selected=true;
        sel.appendChild(o);
      });
    }

    async function getItems(docId, defaults){
      const ref = db.collection(CFG_COL).doc(docId);
      const snap = await ref.get();
      if(!snap.exists){ await ref.set({items: defaults}); return defaults; }
      return snap.data()?.items || defaults;
    }

    async function loadCombos(prefill){
      const [cats,locs,unis] = await Promise.all([
        getItems('categorias',['El√©trica','Hidr√°ulica','Ferramentas']),
        getItems('locais',['Dep√≥sito','Caixa 1','Caixa 2']),
        getItems('unidades',['UN','pct','cx','m','cm','mm','kg','g','L','rolo'])
      ]);
      fillSelect(document.getElementById('iCategoria'), cats, prefill?.categoria);
      fillSelect(document.getElementById('iLocal'),     locs, prefill?.local);
      fillSelect(document.getElementById('iUnidade'),   unis, prefill?.unidade);
    }

    /* ========= Upload / Preview ========= */
    const upBar = document.getElementById('upBar');
    const upBarFill = document.getElementById('upBarFill');
    const upInfo = document.getElementById('iUploadInfo');

    function setUploadInfo(text, type){
      upInfo.textContent = text;
      upInfo.classList.remove('ok','err');
      if(type==='ok') upInfo.classList.add('ok');
      if(type==='err') upInfo.classList.add('err');
    }

    function showProgress(show){
      if(show){ upBar.classList.remove('d-none'); }
      else { upBar.classList.add('d-none'); upBarFill.style.width='0%'; }
    }

    function handleSelectedFile(file){
      if(!file){ setPlaceholder(); return; }
      const reader = new FileReader();
      reader.onload = e => { document.getElementById('iPreview').src = e.target.result; };
      reader.readAsDataURL(file);
      const kb = Math.round(file.size/1024);
      setUploadInfo(`Selecionado: ${file.name || 'foto'} (${kb} KB)`);
    }

    /* ========= C√¢mera (desktop+mobile) ========= */
    let camStream = null;
    let usingBack = true;
    let bsCamModal = null;

    function showCamModal(){
      if(!bsCamModal){ bsCamModal = new bootstrap.Modal(document.getElementById('camModal')); }
      bsCamModal.show();
    }
    function hideCamModal(){
      if(bsCamModal){ bsCamModal.hide(); }
    }

    async function openCamera(){
      if(!navigator.mediaDevices?.getUserMedia){
        alert('Navegador n√£o suporta c√¢mera.'); return;
      }
      const constraints = { video: { facingMode: usingBack ? { ideal:"environment" } : "user" }, audio:false };
      try{
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('camVideo');
        video.srcObject = camStream;
        showCamModal();
      }catch(err){
        console.error(err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique permiss√µes.');
      }
    }

    function stopCamera(){
      if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
      hideCamModal();
    }

    function capturePhoto(){
      const video = document.getElementById('camVideo');
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      c.toBlob(blob=>{
        const file = new File([blob], `foto_${Date.now()}.jpg`, { type:'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(file);
        const foto = document.getElementById('iFoto'); foto.files = dt.files;
        handleSelectedFile(file); stopCamera();
        foto.dispatchEvent(new Event('change',{bubbles:true}));
      }, 'image/jpeg', .92);
    }

    function removeImage(){
      setPlaceholder();
      const f = document.getElementById('iFoto');
      f.value="";
    }

    /* ========= SALVAR (CRIAR/EDITAR) ========= */
    function getExtFromName(name){ const p=name.lastIndexOf('.'); return p>0 ? name.slice(p+1).toLowerCase() : 'jpg'; }

    async function uploadIfNeeded(docId){
      const file = document.getElementById('iFoto').files?.[0];
      if(!file) return null;

      const ext = getExtFromName(file.name || 'jpg');
      const path = `itens/${docId}.${ext}`;
      const ref  = storage.ref(path);

      // garante contentType e mostra progresso
      const metadata = { contentType: file.type || 'image/jpeg' };
      showProgress(true);
      setUploadInfo('Enviando imagem...');

      try{
        const task = ref.put(file, metadata);
        return await new Promise((resolve, reject)=>{
          task.on('state_changed', snap=>{
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            upBarFill.style.width = pct + '%';
          }, err=>{
            showProgress(false);
            setUploadInfo('Falha no upload: ' + (err.message || err.code || 'erro'), 'err');
            reject(err);
          }, async ()=>{
            showProgress(false);
            const url = await task.snapshot.ref.getDownloadURL();
            setUploadInfo('Imagem enviada com sucesso.', 'ok');
            resolve(url);
          });
        });
      }catch(e){
        showProgress(false);
        setUploadInfo('Falha no upload: ' + (e.message || e), 'err');
        return null;
      }
    }

    async function salvarItem(e){
      e.preventDefault();
      const iMsg = document.getElementById('iMsg');

      const nome     = document.getElementById('iNome').value.trim();
      const categoria= document.getElementById('iCategoria').value.trim();
      const qtd      = Number(document.getElementById('iQtd').value || 0);
      const unidade  = document.getElementById('iUnidade').value.trim();
      const local    = document.getElementById('iLocal').value.trim();

      if(!nome || !categoria || !unidade || !local){
        iMsg.textContent = 'Preencha os campos obrigat√≥rios (*).';
        iMsg.classList.remove('ok','err'); iMsg.style.color='#FFD2D2';
        return;
      }

      const btn = document.getElementById('btnSalvar');
      btn.disabled = true; iMsg.textContent = 'Salvando...'; iMsg.classList.remove('ok','err'); iMsg.style.color='';

      try{
        const idParam = new URLSearchParams(location.search).get('id');
        const base = {
          nome, categoria, qtd, unidade, local,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        let docId;
        if(idParam){
          await db.collection('itens').doc(idParam).update(base);
          docId = idParam;
        }else{
          base.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('itens').add(base);
          docId = docRef.id;
        }

        // tenta upload
        const url = await uploadIfNeeded(docId);
        if(url){
          await db.collection('itens').doc(docId).update({ imageUrl: url });
        }

        iMsg.textContent = idParam ? 'Item atualizado com sucesso.' : 'Item criado com sucesso.';
        iMsg.classList.add('ok'); iMsg.style.color='#9BE39B';

        // opcional: redireciona pro dashboard depois de 900ms
        setTimeout(()=>{ location.href='dashboard.html'; }, 900);

      }catch(err){
        console.error(err);
        iMsg.textContent = err.message || 'Erro ao salvar.';
        iMsg.classList.add('err'); iMsg.style.color='#FFD2D2';
        btn.disabled = false; // libera para tentar de novo
      }
    }

    /* ========= START ========= */
    window.addEventListener('firebase-ready', () => {
      setPlaceholder(); // come√ßa com imagem gen√©rica

      // Bot√µes imagem
      document.getElementById('iFoto').addEventListener('change', e=>{
        const f = e.target.files?.[0]; if(f) handleSelectedFile(f); else setPlaceholder();
      });
      document.getElementById('btnAbrirCamera').addEventListener('click', openCamera);
      document.getElementById('btnFecharCam').addEventListener('click', stopCamera);
      document.getElementById('btnCapturar').addEventListener('click', capturePhoto);
      document.getElementById('btnTrocar').addEventListener('click', async ()=>{
        usingBack = !usingBack; stopCamera(); await openCamera();
      });
      document.getElementById('btnRemoverImg').addEventListener('click', removeImage);

      // Auth + combos + preencher se editar + submit
      auth.onAuthStateChanged(async (u)=>{
        if(!u){ location.href='login.html'; return; }

        const id = new URLSearchParams(location.search).get('id');
        if(id){
          const snap = await db.collection('itens').doc(id).get();
          const pre = snap.exists ? snap.data() : null;
          await loadCombos(pre);
          if(pre){
            document.getElementById('iNome').value = pre.nome || '';
            document.getElementById('iQtd').value = Number(pre.qtd || 0);
            document.getElementById('iUnidade').value = pre.unidade || '';
            document.getElementById('iCategoria').value = pre.categoria || '';
            document.getElementById('iLocal').value = pre.local || '';
            document.getElementById('iPreview').src = pre.imageUrl || PLACEHOLDER;
          }
        }else{
          await loadCombos(null);
        }

        document.getElementById('formItem').addEventListener('submit', salvarItem);
      });
    });
  </script>
</body>
</html>
