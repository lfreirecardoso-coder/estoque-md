<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gest√£o de Estoque | Cadastrar ou Editar Item</title>
  <link rel="stylesheet" href="theme.css"/>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" data-sidebar></aside>

    <main class="content" id="page-novo">
      <header class="page-header">
        <h2 class="page-title">Gest√£o de Estoque | Cadastrar ou Editar Item</h2>
        <p class="page-subtitle">
          Preencha os campos. Voc√™ pode tirar uma foto pelo celular ou escolher uma imagem.
          <a class="btn-ghost-link" href="cadastro_base.html">Cadastro Base</a>
        </p>
      </header>

      <div class="card">
        <form id="formItem" novalidate>
          <div class="grid-2">
            <div class="field">
              <label for="iNome">Nome *</label>
              <input id="iNome" type="text" placeholder="Ex.: Fio 2.5 mm" required>
            </div>

            <div class="field">
              <label for="iCategoria">Categoria *</label>
              <select id="iCategoria" required><option value="">‚Äî Selecione ‚Äî</option></select>
            </div>

            <div class="field">
              <label for="iQtd">Quantidade *</label>
              <input id="iQtd" type="number" inputmode="numeric" min="0" step="1" placeholder="Ex.: 10" required>
            </div>

            <div class="field">
              <label for="iUnidade">Unidade *</label>
              <select id="iUnidade" required><option value="">‚Äî Selecione ‚Äî</option></select>
            </div>

            <div class="field full">
              <label for="iLocal">Local de Armazenamento *</label>
              <select id="iLocal" required><option value="">‚Äî Selecione ‚Äî</option></select>
            </div>

            <div class="field full">
              <label>Imagem do Item (opcional)</label>
              <div class="upload-box">
                <img id="iPreview" class="preview" alt="Pr√©-visualiza√ß√£o">
                <div>
                  <input id="iFoto" class="hidden-input" type="file" accept="image/*">
                  <div class="actions">
                    <label for="iFoto" class="btn btn-ghost">üìÇ Escolher arquivo</label>
                    <button type="button" class="btn btn-ghost" id="btnAbrirCamera">üì∏ Tirar foto</button>
                    <button type="button" class="btn btn-danger" id="btnRemoverImg">üóë Remover imagem</button>
                  </div>
                  <div class="hint">
                    No celular, ‚ÄúEscolher arquivo‚Äù abre c√¢mera ou galeria; ‚ÄúTirar foto‚Äù tenta abrir a c√¢mera direta (quando suportado).
                    No computador, usamos ‚ÄúTirar foto‚Äù via navegador.
                  </div>
                  <div class="hint" id="iUploadInfo" style="margin-top:6px;"></div>
                </div>
              </div>
            </div>

            <input id="iImageUrl" type="hidden">
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="btnSalvar">üíæ Salvar</button>
            <a href="dashboard.html" class="btn btn-ghost">Cancelar</a>
            <span class="hint" id="iMsg"></span>
          </div>
        </form>
      </div>
    </main>
  </div>

  <!-- Modal da c√¢mera -->
  <div class="modal" id="camModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="modal-title">C√¢mera</h3>
        <button class="btn btn-ghost" id="btnFecharCam">Fechar</button>
      </div>
      <div class="video-wrap">
        <video id="camVideo" autoplay playsinline></video>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnTrocar">Trocar c√¢mera</button>
        <button class="btn btn-primary" id="btnCapturar">Capturar</button>
      </div>
    </div>
  </div>

  <script src="firebase.js"></script>
  <script src="sidebar.js"></script>
  <script src="app.js"></script>

  <script>
    /* === Combos === */
    const CFG_COL = 'config';
    const PLACEHOLDER =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="320" height="320" viewBox="0 0 320 320">
        <rect width="320" height="320" rx="18" fill="#1f1f1f"/>
        <g fill="none" stroke="#7c6aa8" stroke-width="10" opacity="0.6">
          <rect x="60" y="90" width="200" height="140" rx="12"/>
          <circle cx="120" cy="140" r="22"/>
          <path d="M90 210l48-48 35 35 25-25 32 38"/>
        </g>
      </svg>`);

    function setPlaceholder(){ document.getElementById('iPreview').src = PLACEHOLDER; }

    function fillSelect(sel, arr, selected){
      sel.innerHTML = '<option value="">‚Äî Selecione ‚Äî</option>';
      arr.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
        const o=document.createElement('option');o.value=v;o.textContent=v;
        if(selected && selected===v) o.selected=true;
        sel.appendChild(o);
      });
    }
    async function getItems(docId, defaults){
      const ref = db.collection(CFG_COL).doc(docId);
      const snap = await ref.get();
      if(!snap.exists){ await ref.set({items: defaults}); return defaults; }
      return snap.data()?.items || defaults;
    }
    async function loadCombos(prefill){
      const [cats,locs,unis] = await Promise.all([
        getItems('categorias',['El√©trica','Hidr√°ulica','Ferramentas']),
        getItems('locais',['Dep√≥sito','Caixa 1','Caixa 2']),
        getItems('unidades',['UN','pct','cx','m','cm','mm','kg','g','L','rolo'])
      ]);
      fillSelect(document.getElementById('iCategoria'), cats, prefill?.categoria);
      fillSelect(document.getElementById('iLocal'),     locs, prefill?.local);
      fillSelect(document.getElementById('iUnidade'),   unis, prefill?.unidade);
    }

    function handleSelectedFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => { document.getElementById('iPreview').src = e.target.result; };
      reader.readAsDataURL(file);
      const kb = Math.round(file.size/1024);
      document.getElementById('iUploadInfo').textContent = `Selecionado: ${file.name || 'foto'} (${kb} KB)`;
    }

    /* === C√¢mera (desktop+mobile) === */
    let camStream = null;
    let usingBack = true;

    async function openCamera(){
      if(!navigator.mediaDevices?.getUserMedia){
        alert('Navegador n√£o suporta c√¢mera.'); return;
      }
      const constraints = { video: { facingMode: usingBack ? { ideal:"environment" } : "user" }, audio:false };
      try{
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('camVideo');
        video.srcObject = camStream;
        document.getElementById('camModal').classList.add('open');
      }catch(err){
        console.error(err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique permiss√µes.');
      }
    }
    function stopCamera(){
      if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
      document.getElementById('camModal').classList.remove('open');
    }
    function capturePhoto(){
      const video = document.getElementById('camVideo');
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      c.toBlob(blob=>{
        const file = new File([blob], `foto_${Date.now()}.jpg`, { type:'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(file);
        const foto = document.getElementById('iFoto'); foto.files = dt.files;
        handleSelectedFile(file); stopCamera();
        foto.dispatchEvent(new Event('change',{bubbles:true}));
      }, 'image/jpeg', .92);
    }
    function removeImage(){
      setPlaceholder(); document.getElementById('iFoto').value=""; document.getElementById('iUploadInfo').textContent="";
    }

    window.addEventListener('firebase-ready', () => {
      setPlaceholder();

      auth.onAuthStateChanged(async (u)=>{
        if(!u){ location.href='login.html'; return; }

        const id = new URLSearchParams(location.search).get('id');
        if(id){
          const snap = await db.collection('itens').doc(id).get();
          await loadCombos(snap.exists ? snap.data() : null);
        }else{
          await loadCombos(null);
        }

        document.getElementById('iFoto').addEventListener('change', e=>{
          const f = e.target.files?.[0]; if(f) handleSelectedFile(f); else setPlaceholder();
        });
        document.getElementById('btnAbrirCamera').addEventListener('click', openCamera);
        document.getElementById('btnFecharCam').addEventListener('click', stopCamera);
        document.getElementById('btnCapturar').addEventListener('click', capturePhoto);
        document.getElementById('btnTrocar').addEventListener('click', async ()=>{
          usingBack = !usingBack; stopCamera(); await openCamera();
        });
        document.getElementById('btnRemoverImg').addEventListener('click', removeImage);
      });
    });
  </script>
</body>
</html>
