<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estoque | Cadastro de Estoque</title>

  <!-- Favicons -->
  <link rel="icon" href="favicon.ico?v=20250826" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png?v=20250826" sizes="32x32">
  <link rel="apple-touch-icon" href="apple-touch-icon.png?v=20250826" sizes="180x180">
  <meta name="theme-color" content="#1a0e0e">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tema -->
  <link rel="stylesheet" href="theme.css?v=20250826"/>
  <style>
    .upload-status{ font-size:.95rem }
    .upload-status.ok{ color:#9BE39B }
    .upload-status.err{ color:#FFD2D2 }
    .progress{ height:8px }
    .photo-note{ font-size:.9rem; color:var(--muted); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body class="app-body">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <!-- Botão menu (mobile) -->
      <button class="btn-menu d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Abrir menu">
        <span class="hamburger"></span>
      </button>

      <a class="navbar-brand ms-2" href="dashboard.html">Estoque -MD-</a>

      <div class="ms-auto">
        <button class="btn btn-logout-top" id="btnLogoutTop">Sair</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar d-none d-lg-block" id="sidebar">
    <div class="p-3" data-sidebar-content></div>
  </aside>

  <!-- Botão colapso (desktop) -->
  <button class="btn-menu toggle-desktop d-none d-lg-inline-flex" id="toggleDesktop" title="Colapsar/Expandir menu">
    <span class="hamburger"></span>
  </button>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasMenuLabel">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
    </div>
    <div class="offcanvas-body" id="offcanvasMenuBody"><!-- sidebar.js injeta aqui --></div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container-fluid">

      <header class="mb-3">
        <h2 class="page-title mb-1" id="pageTitle">Cadastro de Estoque</h2>
        <p class="text-muted">
          Preencha os campos. <b>Imagem obrigatória</b> (arquivo ou câmera).
          <a class="btn btn-ghost btn-sm ms-1" href="cadastro_base.html">Cadastro Base</a>
        </p>
      </header>

      <section class="card p-3">
        <form id="formItem" novalidate>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label for="iNome" class="form-label">Nome *</label>
              <input id="iNome" type="text" class="form-control" placeholder="Ex.: Fio 2.5 mm" required>
            </div>

            <div class="col-12 col-lg-6">
              <label for="iCategoria" class="form-label">Categoria *</label>
              <select id="iCategoria" class="form-select" required>
                <option value="">— Selecione —</option>
              </select>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="iQtd" class="form-label">Quantidade *</label>
              <input id="iQtd" type="number" inputmode="numeric" min="0" step="1" class="form-control" placeholder="Ex.: 10" required>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="iUnidade" class="form-label">Unidade *</label>
              <select id="iUnidade" class="form-select" required>
                <option value="">— Selecione —</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <label for="iLocal" class="form-label">Local de Armazenamento *</label>
              <select id="iLocal" class="form-select" required>
                <option value="">— Selecione —</option>
              </select>
            </div>

            <!-- IMAGEM (OBRIGATÓRIA) -->
            <div class="col-12">
              <label class="form-label">Imagem do Item *</label>
              <div class="d-flex gap-3 align-items-start flex-wrap">
                <!-- preview inicial só para UX; não vale como imagem enviada -->
                <img id="iPreview" class="thumb" alt="Pré-visualização" src="img/placeholder.svg"
                     style="width:96px;height:96px;border-radius:12px;border:1px solid var(--border);object-fit:cover"/>
                <div style="min-width:260px">
                  <input id="iFoto" class="d-none" type="file" accept="image/*">
                  <div class="d-flex flex-wrap gap-2">
                    <label for="iFoto" class="btn btn-ghost">📂 Escolher arquivo</label>
                    <button type="button" class="btn btn-ghost" id="btnAbrirCamera">📸 Tirar foto</button>
                    <button type="button" class="btn btn-danger" id="btnRemoverImg">🗑 Remover imagem</button>
                  </div>

                  <div class="photo-note mt-2" id="imgHint">
                    Selecione um arquivo ou tire uma foto. A imagem é obrigatória para salvar.
                  </div>

                  <!-- Status de upload -->
                  <div class="mt-2">
                    <div class="progress d-none" id="upBar"><div class="progress-bar" id="upBarFill" style="width:0%"></div></div>
                    <div class="upload-status" id="iUploadInfo"></div>
                  </div>
                </div>
              </div>
            </div>

            <input id="iImageUrl" type="hidden">
          </div>

          <div class="d-flex align-items-center gap-2 mt-3">
            <button type="submit" class="btn btn-primary" id="btnSalvar" disabled>💾 Salvar</button>
            <a href="dashboard.html" class="btn btn-ghost">Cancelar</a>
            <span class="text-muted ms-2" id="iMsg"></span>
          </div>
        </form>
      </section>

    </div>
  </main>

  <!-- MODAL da CÂMERA -->
  <div class="modal" id="camModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Câmera</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar" id="btnFecharCam"></button>
        </div>
        <div class="modal-body">
          <div class="ratio ratio-4x3" style="background:#000;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
            <video id="camVideo" autoplay playsinline></video>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button class="btn btn-ghost" id="btnTrocar">Trocar câmera</button>
          <button class="btn btn-primary" id="btnCapturar">Capturar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="firebase.js?v=20250826"></script>
  <!-- Sidebar unificada -->
  <script src="sidebar.js?v=20250826"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- LÓGICA -->
  <script>
    // Botão “Sair” do topo
    document.getElementById('btnLogoutTop')?.addEventListener('click', () => {
      if (window.auth && auth.signOut){ auth.signOut().then(()=> location.href='login.html'); }
      else { location.href='login.html'; }
    });

    /* ========= Estado: imagem presente? ========= */
    let HAS_IMAGE = false;      // controla habilitação do Salvar
    let IS_EDIT   = false;      // se estamos editando
    function updateSaveState(){
      const btn = document.getElementById('btnSalvar');
      // Em novo: precisa HAS_IMAGE = true
      // Em edição: permite salvar se já havia imageUrl OU se foi anexado arquivo (HAS_IMAGE)
      if (!IS_EDIT) {
        btn.disabled = !HAS_IMAGE;
      } else {
        // Em edição, se não foi carregado imageUrl anterior e também não há arquivo -> desabilita
        const hadPrev = !!document.getElementById('iPreview')?.dataset.hasPrevImage;
        btn.disabled = !(HAS_IMAGE || hadPrev);
      }
    }

    /* ========= Combos (categorias/locais/unidades) ========= */
    const CFG_COL = 'config';

    function fillSelect(sel, arr, selected){
      sel.innerHTML = '<option value="">— Selecione —</option>';
      arr.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
        const o=document.createElement('option');o.value=v;o.textContent=v;
        if(selected && selected===v) o.selected=true;
        sel.appendChild(o);
      });
    }

    async function getItems(docId, defaults){
      const ref = db.collection(CFG_COL).doc(docId);
      const snap = await ref.get();
      if(!snap.exists){ await ref.set({items: defaults}); return defaults; }
      return snap.data()?.items || defaults;
    }

    async function loadCombos(prefill){
      const [cats,locs,unis] = await Promise.all([
        getItems('categororias',['Elétrica','Hidráulica','Ferramentas']), // (se já existir com outro id, ele mantém)
        getItems('locais',['Depósito','Caixa 1','Caixa 2']),
        getItems('unidades',['UN','pct','cx','m','cm','mm','kg','g','L','rolo'])
      ]).catch(()=>[[],[],[]]);

      fillSelect(document.getElementById('iCategoria'), cats?.length?cats:['Elétrica','Hidráulica','Ferramentas'], prefill?.categoria);
      fillSelect(document.getElementById('iLocal'),     locs?.length?locs:['Depósito','Caixa 1','Caixa 2'],      prefill?.local);
      fillSelect(document.getElementById('iUnidade'),   unis?.length?unis:['UN','pct','cx','m','cm','mm','kg','g','L','rolo'], prefill?.unidade);
    }

    /* ========= Upload / Preview ========= */
    const upBar = document.getElementById('upBar');
    const upBarFill = document.getElementById('upBarFill');
    const upInfo = document.getElementById('iUploadInfo');
    const imgHint = document.getElementById('imgHint');

    function setUploadInfo(text, type){
      upInfo.textContent = text;
      upInfo.classList.remove('ok','err');
      if(type==='ok') upInfo.classList.add('ok');
      if(type==='err') upInfo.classList.add('err');
    }

    function showProgress(show){
      if(show){ upBar.classList.remove('d-none'); }
      else { upBar.classList.add('d-none'); upBarFill.style.width='0%'; }
    }

    function handleSelectedFile(file){
      const preview = document.getElementById('iPreview');
      if(!file){
        preview.src = 'img/placeholder.svg';
        setUploadInfo('Nenhum arquivo selecionado. Imagem é obrigatória.', 'err');
        imgHint.textContent = 'Selecione um arquivo ou use a câmera.';
        HAS_IMAGE = false;
        updateSaveState();
        return;
      }
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; };
      reader.readAsDataURL(file);
      const kb = Math.round(file.size/1024);
      setUploadInfo(`Selecionado: ${file.name || 'foto'} (${kb} KB)`, 'ok');
      imgHint.textContent = '';
      HAS_IMAGE = true;
      updateSaveState();
    }

    /* ========= Câmera ========= */
    let camStream = null;
    let usingBack = true;
    let bsCamModal = null;

    function showCamModal(){
      if(!bsCamModal){ bsCamModal = new bootstrap.Modal(document.getElementById('camModal')); }
      bsCamModal.show();
    }
    function hideCamModal(){
      if(bsCamModal){ bsCamModal.hide(); }
    }

    async function openCamera(){
      if(!navigator.mediaDevices?.getUserMedia){
        alert('Navegador não suporta câmera.'); return;
      }
      const constraints = { video: { facingMode: usingBack ? { ideal:"environment" } : "user" }, audio:false };
      try{
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('camVideo');
        video.srcObject = camStream;
        showCamModal();
      }catch(err){
        console.error(err);
        alert('Não foi possível acessar a câmera. Verifique permissões.');
      }
    }

    function stopCamera(){
      if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
      hideCamModal();
    }

    function capturePhoto(){
      const video = document.getElementById('camVideo');
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0,c.width,c.height);
      c.toBlob(blob=>{
        const file = new File([blob], `foto_${Date.now()}.jpg`, { type:'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(file);
        const foto = document.getElementById('iFoto'); foto.files = dt.files;
        handleSelectedFile(file); stopCamera();
        foto.dispatchEvent(new Event('change',{bubbles:true}));
      }, 'image/jpeg', .92);
    }

    function removeImage(){
      const f = document.getElementById('iFoto');
      f.value="";
      document.getElementById('iPreview').src = 'img/placeholder.svg';
      setUploadInfo('Imagem removida. Selecione outra antes de salvar.', 'err');
      imgHint.textContent = 'Imagem obrigatória.';
      HAS_IMAGE = false;
      updateSaveState();
    }

    /* ========= SALVAR (OBRIGA IMAGEM) ========= */
    function getExtFromName(name){ const p=name.lastIndexOf('.'); return p>0 ? name.slice(p+1).toLowerCase() : 'jpg'; }

    async function uploadIfNeeded(docId){
      const file = document.getElementById('iFoto').files?.[0];
      if(!file) return null; // sem arquivo, não sobe (e validação vai barrar no salvar em "novo")
      const ext = getExtFromName(file.name || 'jpg');
      const path = `itens/${docId}.${ext}`;
      const ref  = storage.ref(path);
      const metadata = { contentType: file.type || 'image/jpeg' };

      showProgress(true);
      setUploadInfo('Enviando imagem...');
      try{
        const task = ref.put(file, metadata);
        return await new Promise((resolve, reject)=>{
          task.on('state_changed', snap=>{
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            upBarFill.style.width = pct + '%';
          }, err=>{
            showProgress(false);
            setUploadInfo('Falha no upload: ' + (err.message || err.code || 'erro'), 'err');
            reject(err);
          }, async ()=>{
            showProgress(false);
            const url = await task.snapshot.ref.getDownloadURL();
            setUploadInfo('Imagem enviada com sucesso.', 'ok');
            resolve(url);
          });
        });
      }catch(e){
        showProgress(false);
        setUploadInfo('Falha no upload: ' + (e.message || e), 'err');
        return null;
      }
    }

    async function salvarItem(e){
      e.preventDefault();
      const iMsg = document.getElementById('iMsg');

      const nome     = document.getElementById('iNome').value.trim();
      const categoria= document.getElementById('iCategoria').value.trim();
      const qtd      = Number(document.getElementById('iQtd').value || 0);
      const unidade  = document.getElementById('iUnidade').value.trim();
      const local    = document.getElementById('iLocal').value.trim();

      if(!nome || !categoria || !unidade || !local){
        iMsg.textContent = 'Preencha os campos obrigatórios (*).';
        iMsg.style.color='#FFD2D2';
        return;
      }

      const idParam = new URLSearchParams(location.search).get('id');
      const isEdit  = !!idParam;

      // Validação de imagem obrigatória
      let mustHaveFile = false;
      if (!isEdit) {
        mustHaveFile = !(document.getElementById('iFoto').files?.[0]);
      } else {
        const hadPrev = !!document.getElementById('iPreview')?.dataset.hasPrevImage;
        if (!hadPrev && !(document.getElementById('iFoto').files?.[0])) {
          mustHaveFile = true;
        }
      }
      if (mustHaveFile) {
        iMsg.textContent = 'Selecione uma imagem para o item antes de salvar.';
        iMsg.style.color = '#FFD2D2';
        setUploadInfo('Imagem obrigatória.', 'err');
        return;
      }

      const btn = document.getElementById('btnSalvar');
      btn.disabled = true; iMsg.textContent = 'Salvando...'; iMsg.style.color='';

      try{
        const base = {
          nome, categoria, qtd, unidade, local,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        let docId;
        if (isEdit){
          await db.collection('itens').doc(idParam).set(base, { merge:true });
          docId = idParam;
        } else {
          base.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await db.collection('itens').add(base);
          docId = docRef.id;
        }

        // Upload (se houver arquivo)
        const url = await uploadIfNeeded(docId);
        if (url){
          await db.collection('itens').doc(docId).update({ imageUrl: url });
        }

        iMsg.textContent = isEdit ? 'Item atualizado com sucesso.' : 'Item criado com sucesso.';
        iMsg.style.color = '#9BE39B';

        setTimeout(()=>{ location.href='dashboard.html'; }, 900);
      }catch(err){
        console.error(err);
        iMsg.textContent = err.message || 'Erro ao salvar.';
        iMsg.style.color = '#FFD2D2';
        btn.disabled = false;
      }
    }

    /* ========= START ========= */
    window.addEventListener('firebase-ready', () => {
      // Botões imagem
      document.getElementById('iFoto').addEventListener('change', e=>{
        const f = e.target.files?.[0]; handleSelectedFile(f);
      });
      document.getElementById('btnAbrirCamera').addEventListener('click', openCamera);
      document.getElementById('btnFecharCam').addEventListener('click', stopCamera);
      document.getElementById('btnCapturar').addEventListener('click', capturePhoto);
      document.getElementById('btnTrocar').addEventListener('click', async ()=>{
        usingBack = !usingBack; stopCamera(); await openCamera();
      });
      document.getElementById('btnRemoverImg').addEventListener('click', removeImage);

      // Auth + combos + preencher se editar + submit
      auth.onAuthStateChanged(async (u)=>{
        if(!u){ location.href='login.html'; return; }

        const id = new URLSearchParams(location.search).get('id');
        IS_EDIT = !!id;

        // combos
        await loadCombos(null);

        if (IS_EDIT){
          const snap = await db.collection('itens').doc(id).get();
          if (snap.exists){
            const pre = snap.data();
            document.getElementById('iNome').value     = pre.nome || '';
            document.getElementById('iQtd').value      = Number(pre.qtd || 0);
            document.getElementById('iUnidade').value  = pre.unidade || '';
            document.getElementById('iCategoria').value= pre.categoria || '';
            document.getElementById('iLocal').value    = pre.local || '';
            const preview = document.getElementById('iPreview');
            if (pre.imageUrl){
              preview.src = pre.imageUrl;
              preview.dataset.hasPrevImage = "1"; // marca que já existe imagem no item
              HAS_IMAGE = false; // ainda não foi anexado novo arquivo, mas pode salvar
            } else {
              preview.src = 'img/placeholder.svg';
              delete preview.dataset.hasPrevImage;
              HAS_IMAGE = false; // vai exigir arquivo
            }
            document.getElementById('pageTitle').textContent = 'Editar Estoque';
          } else {
            // item não encontrado — volta
            location.href = 'dashboard.html';
            return;
          }
        } else {
          // novo: sem imagem ainda
          document.getElementById('iPreview').src = 'img/placeholder.svg';
          HAS_IMAGE = false;
        }

        // estado inicial do botão
        updateSaveState();

        document.getElementById('formItem').addEventListener('submit', salvarItem);
      });
    });
  </script>
</body>
</html>
